---
title: "Practical Fall 2019"
author: "Eugenia Clarissa Halim"
date: "10/28/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Documents/UMich_Bio201_F19-master/")
```

As with each lab, add "completed" to the Rmd filename; update the name in the author line above; update the location of the working directory as necessary. 

# Load packages
```{r Load packages, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(readxl)
library(broom)
library(cowplot)
set.seed(7)
```

# Part 1 - concepts 
Type the answers to questions 1-5 in the space below. 

### Question 1

Given vector v1 below, will it be read as character or numeric? Why does this happen? [1 point]
```{r}
v1 <- c("one", "2", "three", "4")
class(v1) #character
```
It will be read as character because all the vector are in quotation marks and even if the "2" and "4" are not in "", v1 will still be read as a character because character is higher than numeric in the hierarchy of class types.  

### Question 2

dataframe1 has 323 rows and dataframe2 has 345 rows. After an inner join the resulting data fame has 312 rows. Why does the result have fewer rows? [1 point]

The result has fewer rows because in the inner join function, it only takes into account and return all rows from x where there are matching values in y, and all columns from x and y. Because not all are matching, it has fewer rows than the original data frames. 

### Question 3

What are the three assumptions for a t-test? Explain what to do if the variance assumption is violated. Explain what to do if the normality assumption is violated. [3 points]

The three assumptions in a t-test is that the data set is normal, sample size, and variance. If the variance assumption is violated, the t test may have errors and the homogenity of variances is also violated which may lead to the null hypothesis being falsely rejected. If the normality assumption is violated, the t test may not be completely accurate since non parametric tests are more suitable for non normal data because then the difference between the data sets may not be true and the difference detected is not the true difference. 

### Question 4

You have a data frame (called butyrate_df) with the columns: "Participant_ID", "Study_week", "Semester", "Supplement_consumed", "Avg_butyrate". If this data frame is piped to each of the functions below, evaluate if the description of the results is true or false. [3 points]
```{r eval=FALSE, include=FALSE}
butyrate_df %>%
  filter(Semester == "Fall2019")
# Result1 = keeps only data from Fall 2019 semester

butyrate_df %>%
  filter(Avg_butyrate <= 47.0)
# Result2 = keeps only values equal to 47 mmol/kg 

butyrate_df %>%
  group_by(Semester) %>%
  summarize(New_column = median(Avg_butyrate))
# Result3 = new_column contains the median of each participant 
```

Result1: The result description is true. Only data from the Fall 2019 semester in the butyrate_df dataframe will be kept. 
Result2: The result description is false. Instead of keeping only values equal to 47mmol/kg, values less than or equal to 47mmol/kg will be kept. 
Result3: The result description is false. Instead of containing the median of each participant, it contains the median of the average butyrate of each participant in a new column. 

### Question 5

something about NAs

The data frame (called breath_df) has the columns: "Participant_ID", "Study_week", "Semester", "Supplement_consumed", "Methane", "Hydrogen", "Carbon_dioxide". This data frame is used for the code below, explain what will happen to any NAs in each of the shown calculations, and how the NAs will effect the underlying data. [2 points]
```{r eval=FALSE, include=FALSE}
# Option 1
breath_df %>%
  filter(!is.na(Methane)) %>% 
  group_by(Participant_ID, Study_week) %>%
  summarize(Avg_methane = mean(Methane))

# Option 2
breath_df %>%
  group_by(Participant_ID, Study_week) %>%
  summarize(Avg_methane = mean(Methane, na.rm = TRUE))
```

In Option 1, the filter function will remove the not available values for methane before we attempt to calculte the summary of mean of methane. The underlying data will have a mean calculated based solely from participants who have available and reliable data on methane concentrations. 

In Option 2, it is just an alternative way of removing data that is not available for methane concentrations in the breath. The result will still be the same as Option 1 where the mean is calculated solely from students who have available and reliable data on methane concentrations. 

# Part 2 - tidy data 

### Question 6

Find the data frame matching your unique name in the GitHub repository. Find the breath gas and taxa abundance data frames. Download and import all into RStudio and use these data frames to complete the rest of the practical. Name the dataframe to match your uniqname, name the breath gas data frame "breath", name the taxa abundance data frame "taxa". [1 point]
```{r}
# data import code 
echalim <- read_delim("Practial/Raw_data/echalim.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) 
breath <- read_delim("Practial/Raw_data/breath.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) 
taxa <- read_delim("Practial/Raw_data/taxa.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) 
```

Update column names in all files match the course conventions. [1 point]
```{r}
echalim <- read_delim("Practial/Raw_data/echalim.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower)
breath <- read_delim("Practial/Raw_data/breath.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower)
taxa <- read_delim("Practial/Raw_data/taxa.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower)


```

View the supplement types in your semester. Are they all entered in the same style? If not update them to match. [1 point]
```{r}
echalim <- read_delim("Practial/Raw_data/echalim.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  mutate(supplement_consumed=toupper(supplement_consumed))


```

### Question 7

What are the dimensions of each data frame? Write the results as a comment after the function. [1 point]
```{r}
nrow(echalim) #482 rows 
nrow(breath) #2668 rows
nrow(taxa) #46881 rows 
ncol(echalim) #9 columns 
ncol(breath) #5 columns
ncol(taxa) #6 columns 

```

Select a join that will drop as few data points as possible. Join the data frame containing the participant data with the breath gas data. Name this "joined_df". [1 point]
```{r}
joined_df <- full_join(echalim, breath)
```

What are the dimensions of the joined data frame? Write the results as a comment after the function. [1 point]
```{r}
dim(joined_df) #3159 rows and 11 columns in the joined data frame
```

### Question 8

Calculate the total SCFAs. [1 point]
```{r}
total_SCFAs <- joined_df %>%
  group_by(participant_id, study_week, semester, acetate_mmol_kg, butyrate_mmol_kg, propionate_mmol_kg) %>%
  summarize(total_SCFA = sum (acetate_mmol_kg + butyrate_mmol_kg + propionate_mmol_kg))

```

Calculate the weekly mean of each SCFA of each participant. Calculate the weekly mean methane and hydrogen levels of each participant. [1 point]
```{r}
joined_df_new <- joined_df %>%
  group_by(participant_id, study_week, semester, supplement_consumed) %>%
  summarize(mean_acetate = mean(acetate_mmol_kg), 
            mean_butyrate = mean(butyrate_mmol_kg), 
            mean_propionate = mean(propionate_mmol_kg),
            mean_ch4 = mean(ch4),
            mean_h2 = mean(h2))
  
```

What are the dimensions of the data frame with the avearges? Write the results as a comment after the function.
```{r}
dim(joined_df_new) #1109 rows and 9 columns
```

Join this data frame with the one called "taxa". Name the new data frame "all_data". What are the dimensions of this new data frame? [1 point]
```{r}
all_data <- full_join(taxa, joined_df_new)
```

Save all data frames generated to your GitHub page. [1 point]
```{r}
write_delim(all_data, 
            path="Practial/curated_data/all_data.txt",
            delim = "\t", quote = FALSE, col_names = TRUE)
write_delim(breath, 
            path="Practial/curated_data/breath.txt",
            delim = "\t", quote = FALSE, col_names = TRUE)
write_delim(echalim, 
            path="Practial/curated_data/echalim.txt",
            delim = "\t", quote = FALSE, col_names = TRUE)
write_delim(joined_df, 
            path="Practial/curated_data/joined_df.txt",
            delim = "\t", quote = FALSE, col_names = TRUE)
write_delim(joined_df_new, 
            path="Practial/curated_data/joined_df_new.txt",
            delim = "\t", quote = FALSE, col_names = TRUE)
write_delim(taxa, 
            path="Practial/curated_data/taxa.txt",
            delim = "\t", quote = FALSE, col_names = TRUE)
write_delim(total_SCFAs, 
            path="Practial/curated_data/total_SCFAs.txt",
            delim = "\t", quote = FALSE, col_names = TRUE)
```

# Part 3 - statistics & graphics 

Update all axes labels and figure titles so they are informative and easy to read. Upload final plots to GitHub. When specified, conduct the appropriate tests, and write the statistic (p, F, R value) as a comment. 

### Question 9

If you have more than one type of supplement consumed in your semester, filter for one type to answer Question 9. Plot each SCFA with the study week (weeks 1 and 3 only) on the x-axis. Make each study week a different color. Hint: you may have to use facets, or create individual plots and combine them into a multi-panelled figure. [3 points]
```{r}
plot_wk1 <- echalim %>%
  filter(study_week == "week1", supplement_consumed == "transition_HiMaize") %>%
  ggplot(aes(x = study_week, 
             y = acetate_mmol_kg, butyrate_mmol_kg, propionate_mmol_kg)) +
    geom_point(color = "blue") +
    labs(title = "Week 1",
         x = "Study Week",
         y = "SCFAs (mmol/kg)") +
    theme(axis.text.x = element_blank(),
          legend.position = "none")

plot_wk3 <- echalim %>%
  filter(study_week == "week3", supplement_consumed == "transition_HiMaize") %>%
  ggplot(aes(x = study_week, 
             y = acetate_mmol_kg, butyrate_mmol_kg, propionate_mmol_kg)) +
    geom_point(color = "red") +
    labs(title = "Week 3",
         x = "Study Week",
         y = "SCFAs (mmol/kg)") +
    theme(axis.text.x = element_blank(),
          legend.position = "none")

plot_grid(plot_wk1, plot_wk3, 
          nrow = 1, ncol = 2)

save_plot(filename = "Practial/figures/plot_wk1.pdf",
          plot = plot_wk1,
          nrow = 1, ncol = 2, 
          base_aspect_ratio = 1.1)
save_plot(filename = "Practial/figures/plot_wk3.pdf",
          plot = plot_wk3,
          nrow = 1, ncol = 2, 
          base_aspect_ratio = 1.1)

```

Based on the data presented in the plot you generated above, identify which statistical test you would need to determine if there was a change in SCFA concentration between weeks 1 and 3 of the study. Check the assumptions appropriate for the test. [3 points]
```{r}
# assumptions
wk_1 <- echalim %>%
  filter(study_week == "week1", 
         supplement_consumed == "transition_HiMaize") 
shapiro.test(wk_1$acetate_mmol_kg) 
ggplot(wk_1, aes(x = acetate_mmol_kg)) + geom_histogram()

wk_3 <- echalim %>%
  filter(study_week == "week3", 
         supplement_consumed == "transition_HiMaize") 
shapiro.test(wk_3$acetate_mmol_kg) 
ggplot(wk_3, aes(x = acetate_mmol_kg)) + geom_histogram()


# test 
t.test(x = wk_1$acetate_mmol_kg, 
       y = wk_3$acetate_mmol_kg,
       alternative = "less", paired = FALSE, var.equal = FALSE)
# result?
#the p-value is 0.04272 which means that it is small (<0.05) and the result is significant. This means that we fail to reject the null hypothesis that there is no change in SCFA concentration between weeks 1 and 3 of the study. 
```

Based on the results of the test, conclude if there was a difference in SCFAs between weeks. 

There is no difference between SCFAs between weeks. 

### Question 10

Is there a correlation between the abundace of hydrogen generators and breath hydrogen? Create a plot that shows the relationship and conduct the appropriate statistical test(s). [2 points]
```{r}
# plot
h2_abundance <- all_data %>%
  ggplot(aes(x = mean_h2,
             y = fract)) + 
  geom_point() + 
  geom_smooth(method = "lm", 
              se = FALSE) +  
  xlab("breath hydrogen (ppm)") + 
  ylab("abundance of hydrogen generators") 


save_plot(filename = "Practial/figures/h2_abundance.pdf",
          plot = h2_abundance,
          nrow = 1, ncol = 2, 
          base_aspect_ratio = 1.1)

# correlation test 
m10a <- all_data %>%
  lm(mean_h2 ~ fract, data = .)
# test
summary(m10a)
# result?
```

What can you conclude from these results?

This p-value is high (p-value = 0.3109), so we do not have significance. Also, when we look at the adjusted R-squared value which indicates the quality of linear fit (R-squared = 8.683e-07), it is  low since it is lower than 0.8 which means it is a low quality fit. Hence, there is no correlation between he abundance of hydrogen generators and breath hydrogen. 

Is there a correlation between the abundace of hydrogen consumers and breath methane? Create a plot that shows the relationship and conduct the appropriate statistical test(s). [2 points]
```{r}
# plot
ch4_abundance <- all_data %>%
  ggplot(aes(x = mean_ch4,
             y = fract)) + 
  geom_point() + 
  geom_smooth(method = "lm", 
              se = FALSE) +  
  xlab("breath methane (ppm)") + 
  ylab("abundance of hydrogen consumers") 


save_plot(filename = "Practial/figures/ch4_abundance.pdf",
          plot = ch4_abundance,
          nrow = 1, ncol = 2, 
          base_aspect_ratio = 1.1)
# test
m10b <- all_data %>%
  lm(mean_ch4 ~ fract, data = .)
summary(m10b)
# result?
```

What can you conclude from these results?

This p-value is low (p-value < 2.267e-10), so we do have significance. However, when we look at the adjusted R-squared value which indicates the quality of linear fit (R-squared = 0.001262), it is  low since it is lower than 0.8 which means it is a low quality fit. Hence, there is only a small relationship between the abundance of hydrogren consumers and breath methane.  

### Extra credit:

Is the abundace of hydrogen producers and consumers related? Create a plot, check assumptions, conduct the appropriate statistical test(s), and interpret the results. [1 point]
```{r}
# plot
h2_relationship <- all_data %>%
  ggplot(aes(x = mean_ch4,
             y = mean_h2)) + 
  geom_point() + 
  geom_smooth(method = "lm", 
              se = FALSE) +  
  xlab("abundance of hydrogen conosumers") + 
  ylab("abundance of hydrogen producers") 

save_plot(filename = "Practial/figures/h2_relationship.pdf",
          plot = h2_relationship,
          nrow = 1, ncol = 2, 
          base_aspect_ratio = 1.1)
# test(s)
m11 <- all_data %>%
  lm(mean_ch4 ~ mean_h2, data = .)
summary(m11)

```

This p-value is low (p-value = 0.000303), so we do have significance. However, when we look at the adjusted R-squared value which indicates the quality of linear fit (R-squared = 0.001203), it is  low since it is lower than 0.8 which means it is a low quality fit. Hence, there is only a small relationship between the abundance of hydrogren consumers and producers.  


-----
end